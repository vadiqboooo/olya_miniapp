# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp

## üéØ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å Telegram:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –∞–∫—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –ù–∞—Ç–∏–≤–Ω—ã–µ Telegram UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (MainButton, BackButton)

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp –≤ Telegram
    ‚Üì
–ü–æ–ª—É—á–∞–µ–º telegram_id
    ‚Üì
–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ
    ‚Üì
–ù–ï–¢ ‚Üí –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚Üì
–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /onboarding
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É
    ‚Üì
–°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    ‚Üì
–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ /tracker/{programId}
```

### 2. –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp –≤ Telegram
    ‚Üì
–ü–æ–ª—É—á–∞–µ–º telegram_id
    ‚Üì
–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ
    ‚Üì
–î–ê ‚Üí –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚Üì
–ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞
    ‚Üì
–î–ê ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ /tracker/{programId}
–ù–ï–¢ ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ /onboarding
```

---

## üì¶ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. `useTelegram` Hook
**–§–∞–π–ª:** `src/hooks/useTelegram.js`

–ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp API.

```javascript
const { user, tg, isReady } = useTelegram();

// user.id - telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// user.firstName - –∏–º—è
// user.username - username
```

**–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**
–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID `12345`.

### 2. `TelegramAuthProvider` Context
**–§–∞–π–ª:** `src/context/TelegramAuthContext.jsx`

–£–ø—Ä–∞–≤–ª—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞–º–∏.

```javascript
const { currentUser, telegramUser } = useTelegramAuth();

// currentUser - –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã (id, telegram_id, created_at)
// telegramUser - –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram (id, firstName, username)
```

**–õ–æ–≥–∏–∫–∞:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç/—Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
- –î–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç

---

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Bot

### 1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather

```
/newbot
–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞: Fitness Trainer
Username: YourFitnessBot
```

–ü–æ–ª—É—á–∏—Ç–µ **BOT_TOKEN**.

### 2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ WebApp

```
/newapp
–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞
–ù–∞–∑–≤–∞–Ω–∏–µ: Fitness Trainer
–û–ø–∏—Å–∞–Ω–∏–µ: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä
–§–æ—Ç–æ: –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∫–æ–Ω–∫—É
URL: https://miniapp.rancheasy.ru
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Menu Button

```
/setmenubutton
–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞
URL: https://miniapp.rancheasy.ru
Text: –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
```

---

## üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤–Ω–µ Telegram —Å —Ñ–µ–π–∫–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:

```bash
npm run dev
# –û—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:5173
# –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID 12345
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Telegram (—á–µ—Ä–µ–∑ ngrok)

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker-compose up -d

# 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok (–µ—Å–ª–∏ –Ω–µ—Ç)
# https://ngrok.com/download

# 3. –°–æ–∑–¥–∞–π—Ç–µ —Ç—É–Ω–Ω–µ–ª—å
ngrok http 443

# 4. –ü–æ–ª—É—á–∏—Ç–µ HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://abc123.ngrok.io)

# 5. –û–±–Ω–æ–≤–∏—Ç–µ WebApp URL –≤ @BotFather
/setmenubutton
URL: https://abc123.ngrok.io
```

### Production —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram
# –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏"
# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É: https://miniapp.rancheasy.ru
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è initData

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –í production –Ω—É–∂–Ω–æ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å `initData` –Ω–∞ –±—ç–∫–µ–Ω–¥–µ!

–°–µ–π—á–∞—Å –º—ã –¥–æ–≤–µ—Ä—è–µ–º `telegram_id` –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, –Ω–æ —ç—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ.

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:**

1. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `window.Telegram.WebApp.initData` –Ω–∞ backend
2. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å —á–µ—Ä–µ–∑ `SECRET_KEY` –±–æ—Ç–∞
3. Backend –∏–∑–≤–ª–µ–∫–∞–µ—Ç `user.id` –∏–∑ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–º–µ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (Python):**

```python
import hashlib
import hmac
from urllib.parse import parse_qsl

def validate_telegram_data(init_data: str, bot_token: str) -> dict:
    """–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç initData –æ—Ç Telegram"""
    parsed_data = dict(parse_qsl(init_data))
    hash_value = parsed_data.pop('hash', None)

    if not hash_value:
        raise ValueError("Invalid init data")

    # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    data_check_string = '\n'.join(
        f"{k}={v}" for k, v in sorted(parsed_data.items())
    )

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å—å
    secret_key = hmac.new(
        b"WebAppData",
        bot_token.encode(),
        hashlib.sha256
    ).digest()

    calculated_hash = hmac.new(
        secret_key,
        data_check_string.encode(),
        hashlib.sha256
    ).hexdigest()

    if calculated_hash != hash_value:
        raise ValueError("Invalid hash")

    return parsed_data
```

---

## üé® Telegram UI

### MainButton

```javascript
import { useTelegram } from '../hooks/useTelegram';

const { showMainButton, hideMainButton } = useTelegram();

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É
showMainButton('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', () => {
  console.log('Button clicked!');
  navigate('/next-page');
});

// –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É
hideMainButton();
```

### BackButton

```javascript
const { showBackButton, hideBackButton } = useTelegram();

// –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
showBackButton(() => {
  navigate(-1);
});

// –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É
hideBackButton();
```

### Alerts

```javascript
const { showAlert, showConfirm } = useTelegram();

// –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
showAlert('–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
const confirmed = await showConfirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?');
if (confirmed) {
  // –î–µ–π—Å—Ç–≤–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
}
```

---

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ Users

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    telegram_id TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### –¢–∞–±–ª–∏—Ü–∞ UserProgress

```sql
CREATE TABLE user_progress (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    program_id INTEGER NOT NULL,
    workout_id INTEGER NOT NULL,
    is_completed BOOLEAN DEFAULT FALSE,
    completed_at TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Telegram WebApp API not found"

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω–µ Telegram

**–†–µ—à–µ–Ω–∏–µ:**
- –í production: –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞
- –í dev: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–µ–π–∫–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (ID 12345)

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. Backend –∑–∞–ø—É—â–µ–Ω: `curl https://miniapp.rancheasy.ru/api/programs`
2. –õ–æ–≥–∏ frontend: `docker-compose logs frontend`
3. –õ–æ–≥–∏ backend: `docker-compose logs backend`

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ onboarding

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ OnboardingForm
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint: `POST /api/progress`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs -f`

---

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Telegram WebApp Documentation](https://core.telegram.org/bots/webapps)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [BotFather](https://t.me/BotFather)

---

## üéØ Roadmap

–ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è initData –Ω–∞ backend
- [ ] –•—Ä–∞–Ω–µ–Ω–∏–µ Telegram username/name –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram bot
- [ ] –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞—Ö
- [ ] –®–∞—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ Telegram
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ Premium —á–µ—Ä–µ–∑ Telegram Payments
